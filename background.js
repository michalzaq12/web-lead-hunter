function makeArrayUnique(array) {
    function onlyUnique(value, index, self) {
        return self.indexOf(value) === index;
      }
     return array.filter(onlyUnique); 
}

function upperCaseFirstLetter(string) {
    return string.charAt(0).toUpperCase() + string.slice(1).toLowerCase();
}

function parseName(name) {
    if (!name) return '';
    return upperCaseFirstLetter(name.replaceAll(' ', ''));
}


function onLead(lead) {
    if (!lead.emails) return;
    console.log('LEAD', lead);
    lead.emails = makeArrayUnique(lead.emails);
    lead.names = makeArrayUnique(lead.names);
    const subArray = [];
    for (const email of lead.emails) {
        subArray.push({
            name: lead.names && lead.names.length === 1 ? parseName(lead.names[0]) : '',
            email: email,
            title: lead.title
        })
    }
    save(subArray);
}


const DATA_KEY = 'leads';


function save (subArray){
    console.log(subArray);
    // subArray = [{email, url, title}]
    chrome.storage.local.get({[DATA_KEY]: []}, result => {
        const savedData = result[DATA_KEY];
        for (const lead of subArray) {
            if (savedData.find(el => el.email === lead.email)) continue;
            savedData.push(lead);
        }
        chrome.storage.local.set({[DATA_KEY]: savedData});
    });
}

function onData(response) {
    if (!response) return;
    const data = response[0].result;
    console.log('DATA', data);
    const extractEmails = text => text.match(/([a-zA-Z0-9._-]+@[a-zA-Z0-9._-]+\.[a-zA-Z0-9._-]+)/gi);
    const extractNames = text => text.replaceAll('\n', ' ').match(new RegExp(POLISH_NAMES.join(" | "), "gi"));
    onLead({
        url: data.url,
        title: data.title,
        emails: extractEmails(data.bodyText),
        names: extractNames(data.bodyText)
    })
}


chrome.tabs.onUpdated.addListener((tabId, change, tab) => {

    // Omit empty or chrome specific tabs
    if (!tab.url.startsWith('http')) return;

    // Only scrap data after page load complete event
    if (change.status !== 'complete') return;

    function getData() {
        // USER TAB JS CONTEXT = dont use any functions / vars outside this scope
        return {
            url: document.location.hostname,
            title: document.title,
            bodyText: document.body.innerText
        }
    }

    chrome.scripting.executeScript(
        {
            target: { tabId: tabId },
            function: getData,
        },
        onData
    );



})


// https://gist.github.com/hywak/eccf0c11f7254e9a7c18
const POLISH_NAMES = [
'Arleta',
'Atena',
'Augustyna',
'Aurelia',
'Barbara',
'Beata',
'Bianka',
'Bogna',
'Bogumiła',
'Bożena',
'Brygida',
'Cecylia',
'Celestyna',
'Celina',
'Czesława',
'Dagmara',
'Danuta',
'Daria',
'Diana',
'Dominika',
'Dorota',
'Dżesika',
'Edyta',
'Eleonora',
'Eliza',
'Elwira',
'Elżbieta',
'Emilia',
'Ewa',
'Ewelina',
'Faustyna',
'Felicja',
'Fryderyka',
'Genowefa',
'Grażyna',
'Halina',
'Hanna',
'Helena',
'Honorata',
'Ida',
'Iga',
'Ilona',
'Inga',
'Irena',
'Iwona',
'Izabela',
'Izolda',
'Jadwiga',
'Jagoda',
'Janina',
'Joanna',
'Jolanta',
'Jowita',
'Judyta',
'Julia',
'Julianna',
'Julita',
'Justyna',
'Juta',
'Kaja',
'Kalina',
'Karina',
'Karolina',
'Katarzyna',
'Kasandra',
'Kinga',
'Klara',
'Klarysa',
'Klaudia',
'Klaudyna',
'Klementyna',
'Kleopatra',
'Konstancja',
'Kordula',
'Kornelia',
'Krystyna',
'Ksawera',
'Ksenia',
'Lana',
'Larysa',
'Laura',
'Lea',
'Lejla',
'Lena',
'Leokadia',
'Leonarda',
'Leoncja',
'Leonora',
'Lidia',
'Ligia',
'Lilia',
'Liliana',
'Linda',
'Liwia',
'Lora',
'Luborada',
'Lucyna',
'Ludmiła',
'Ludwika',
'Luiza',
'Luna',
'Łucja',
'Magda',
'Magdalena',
'Maja',
'Malwina',
'Małgorzata',
'Manuela',
'Marcela',
'Maria',
'Marika',
'Mariola',
'Marlena',
'Marta',
'Martyna',
'Maryja',
'Maryla',
'Maryna',
'Marzena',
'Matylda',
'Melania',
'Michalina',
'Milena',
'Milomira',
'Miłosława',
'Miłowita',
'Mira',
'Mirabela',
'Miranda',
'Mirela',
'Miriam',
'Mirka',
'Miroda',
'Mirołada',
'Mirosława',
'Mojmira',
'Monika',
'Morzana',
'Morzena',
'Nadia',
'Nadzieja',
'Najmiła',
'Najsława',
'Narcyza',
'Natalia',
'Natasza',
'Nela',
'Nika',
'Nikola',
'Nikoleta',
'Nina',
'Nora',
'Norma',
'Oda',
'Odeta',
'Odyla',
'Ofelia',
'Oksana',
'Oktawia',
'Ola',
'Olga',
'Olimpia',
'Oliwia',
'Oriana',
'Ota',
'Otylia',
'Ożanna',
'Olena',
'Pamela',
'Patrycja',
'Paula',
'Paulina',
'Pelagia',
'Petra',
'Petronela',
'Petronia',
'Placyda',
'Pola',
'Polmira',
'Przybysława',
'Rachela',
'Ramona',
'Radmiła',
'Rafaela',
'Rajmunda',
'Rajna',
'Raszyda',
'Rebeka',
'Regina',
'Remigia',
'Renata',
'Rita',
'Rodzisława',
'Roksana',
'Roma',
'Romualda',
'Rozalia',
'Rozalinda',
'Rozamunda',
'Rozetta',
'Rozwita',
'Róża',
'Rudolfina',
'Ruta',
'Sabina',
'Safira',
'Salma',
'Saloma',
'Salomea',
'Samanta',
'Sandra',
'Sara',
'Selena',
'Selma',
'Serafina',
'Sędomira',
'Sędzisława',
'Sława',
'Sławina',
'Sonia',
'Stamira',
'Stefania',
'Stela',
'Stoisława',
'Stella',
'Sydney',
'Strzeżymira',
'Subisława',
'Sulima',
'Sulisława',
'Sybilla',
'Sylwana',
'Sylwia',
'Szarlota',
'Szarlin',
'Szarlina',
'Szejma',
'Świetlana',
'Świętomira',
'Świętosława',
'Tabita',
'Tacjana',
'Tadea',
'Tamara',
'Tatiana',
'Tekla',
'Telimena',
'Teodora',
'Teodozja',
'Teresa',
'Tęgomira',
'Tina',
'Tolisława',
'Tomiła',
'Tomisława',
'Tulimira',
'Ulana',
'Ulryka',
'Uma',
'Una',
'Unima',
'Urszula',
'Uta',
'Walentyna',
'Waleria',
'Wanda',
'Wanessa',
'Wera',
'Weronika',
'Wesna',
'Wiara',
'Wielina',
'Wiera',
'Wierada',
'Wiesława',
'Wiktoria',
'Wilhelmina',
'Wilma',
'Wincentyna',
'Wioleta',
'Wirgilia',
'Wirginia',
'Wisława',
'Władysława',
'Włodzimiera',
'Wolimira',
'Wrocisława',
'Zaida',
'Zaira',
'Zdzisława',
'Zefiryna',
'Zenobia',
'Zofia',
'Zuzanna',
'Zwinisława',
'Zygfryda',
'Zyta',
'Żaklina',
'Żaneta',
'Żanna',
'Żelisława',
'Żużanna',
'Żywia',
'Żywisława',
'Abdon',
'Abel',
'Abelard',
'Abraham',
'Achilles',
'Achmed',
'Adam',
'Adelard',
'Adnan',
'Adrian',
'Agapit',
'Agaton',
'Agrypin',
'Ajdin',
'Albert',
'Albin',
'Albrecht',
'Aleksander',
'Aleksy',
'Alfons',
'Alfred',
'Alojzy',
'Alwin',
'Amadeusz',
'Ambroży',
'Anastazy',
'Anatol',
'Andrzej',
'Anioł',
'Annasz',
'Antoni',
'Antonin',
'Antonius',
'Anzelm',
'Apollo',
'Apoloniusz',
'Ariel',
'Arkadiusz',
'Arkady',
'Arnold',
'Aron',
'Artur',
'August',
'Augustyn',
'Aurelian',
'Baldwin',
'Baltazar',
'Barabasz',
'Barnim',
'Bartłomiej',
'Bartosz',
'Bazyli',
'Beat',
'Benedykt',
'Beniamin',
'Benon',
'Bernard',
'Bert',
'Błażej',
'Bodosław',
'Bogdał',
'Bogdan',
'Boguchwał',
'Bogumił',
'Bogumir',
'Bogusław',
'Bogusz',
'Bolebor',
'Bolelut',
'Bolesław',
'Bonawentura',
'Bonifacy',
'Borys',
'Borysław',
'Borzywoj',
'Bożan',
'Bożidar',
'Bożydar',
'Bożimir',
'Bromir',
'Bronisław',
'Bruno',
'Brunon',
'Budzisław',
'Cecyl',
'Cecylian',
'Celestyn',
'Cezar',
'Cezary',
'Chociemir',
'Chrystian',
'Chwalibóg',
'Chwalimir',
'Chwalisław',
'Cichosław',
'Cyprian',
'Cyryl',
'Czesław',
'Dajmir',
'Dal',
'Dalbor',
'Damazy',
'Damian',
'Daniel',
'Danisław',
'Danko',
'Dargomir',
'Dargosław',
'Dariusz',
'Darwit',
'Dawid',
'Denis',
'Derwit',
'Dionizy',
'Dobiesław',
'Dobrogost',
'Dobrosław',
'Domasław',
'Dominik',
'Donald',
'Donat',
'Dorian',
'Duszan',
'Dymitr',
'Dyter',
'Dżamil',
'Dżan',
'Dżem',
'Dżemil',
'Edmund',
'Edward',
'Edwin',
'Efrem',
'Eliasz',
'Eligiusz',
'Emanuel',
'Emil',
'Emir',
'Erazm',
'Ernest',
'Erwin',
'Eugeniusz',
'Eryk',
'Ewald',
'Ewaryst',
'Ezaw',
'Ezechiel',
'Fabian',
'Farid',
'Faris',
'Faustyn',
'Felicjan',
'Feliks',
'Ferdynand',
'Filip',
'Florentyn',
'Florian',
'Fortunat',
'Franciszek',
'Fryc',
'Fryderyk',
'Gabriel',
'Gaj',
'Gardomir',
'Gaweł',
'Gerard',
'Gerwazy',
'Gilbert',
'Ginter',
'Gniewomir',
'Godfryg',
'Godfryd',
'Godzisław',
'Gościsław',
'Gracjan',
'Grodzisław',
'Grzegorz',
'Grzymisław',
'Gustaw',
'Gwalbert',
'Gwido',
'Gwidon',
'Hadrian',
'Hamza',
'Hanusz',
'Hasan',
'Hektor',
'Heliodor',
'Henryk',
'Herakles',
'Herbert',
'Herman',
'Hermes',
'Hiacynt',
'Hieronim',
'Hilary',
'Hipolit',
'Honorat',
'Horacy',
'Hubert',
'Hugo',
'Hugon',
'Husajn',
'Idzi',
'Ignacy',
'Igor',
'Ildefons',
'Inocenty',
'Ireneusz',
'Iwan',
'Iwo',
'Iwon',
'Izajasz',
'Izydor',
'Jacek',
'Jacenty',
'Jakub',
'Jan',
'January',
'Janusz',
'Jarad',
'Jaromir',
'Jaropełk',
'Jarosław',
'Jarowit',
'Jeremiasz',
'Jerzy',
'Jędrzej',
'Joachim',
'Jona',
'Jonasz',
'Jonatan',
'Jozafat',
'Józef',
'Józefat',
'Julian',
'Juliusz',
'Jur',
'Juri',
'Justyn',
'Justynian',
'Jasuf',
'Kacper',
'Kain',
'Kajetan',
'Kajfasz',
'Kajusz',
'Kamil',
'Kanimir',
'Karol',
'Kasjusz',
'Kasper',
'Kastor',
'Kazimierz',
'Kemal',
'Kilian',
'Klaudiusz',
'Klemens',
'Kochan',
'Kondrat',
'Konrad',
'Konradyn',
'Konstancjusz',
'Konstanty',
'Konstantyn',
'Kordian',
'Kornel',
'Korneli',
'Korneliusz',
'Kosma',
'Kryspyn',
'Krystian',
'Krystyn',
'Krzesisław',
'Krzysztof',
'Ksawery',
'Kwiatosław',
'Kwietosław',
'Lambert',
'Laurencjusz',
'Lech',
'Lechosław',
'Lenart',
'Leo',
'Leon',
'Leokadiusz',
'Leonard',
'Leopold',
'Lesław',
'Leszek',
'Lew',
'Longin',
'Lubisław',
'Lubogost',
'Lubomił',
'Lubomir',
'Luborad',
'Lubosław',
'Lucjan',
'Ludmił',
'Ludomił',
'Ludolf',
'Ludomir',
'Ludowit',
'Ludwik',
'Ładysław',
'Łazarz',
'Łucjan',
'Łukasz',
'Maciej',
'Magnus',
'Makary',
'Maksymilian',
'Malachiasz',
'Mamert',
'Manfred',
'Manuel',
'Marcel',
'Marceli',
'Marcin',
'Marcjan',
'Marek',
'Marian',
'Marin',
'Mariusz',
'Maryn',
'Mateusz',
'Maurycjusz',
'Maurycy',
'Maurycjusz',
'Medard',
'Melchior',
'Metody',
'Michał',
'Mieszko',
'Mieczysław',
'Mikołaj',
'Milan',
'Miłobąd',
'Miłogost',
'Miłomir',
'Miłorad',
'Miłosław',
'Miłowan',
'Miłowit',
'Miłosz',
'Miłowit',
'Mirod',
'Miroład',
'Miron',
'Mirosław',
'Mirosz',
'Modest',
'Mojmierz',
'Mojmir',
'Mojżesz',
'Mściwoj',
'Muhamed',
'Murat',
'Myślimir',
'Napoleon',
'Narcyz',
'Nasif',
'Natan',
'Natanael',
'Nataniel',
'Nestor',
'Nicefor',
'Niecisław',
'Nikodem',
'Norbert',
'Norman',
'Odo',
'Odon',
'Oktawian',
'Oktawiusz',
'Olaf',
'Oleg',
'Olgierd',
'Omar',
'Onufry',
'Oskar',
'Orian',
'Otniel',
'Oswald',
'Otokar',
'Otto',
'Otton',
'Owidiusz',
'Pabian',
'Pafnucy',
'Pakosław',
'Pankracy',
'Paskal',
'Patrycjusz',
'Patryk',
'Paweł',
'Pelagiusz',
'Petroniusz',
'Piotr',
'Placyd',
'Polikarp',
'Prokop',
'Prot',
'Protazy',
'Przemysł',
'Przemysław',
'Przedpełk',
'Przybysław',
'Radogost',
'Radomił',
'Radomir',
'Radosław',
'Radowit',
'Radzimir',
'Rafał',
'Rajmund',
'Rajner',
'Remigiusz',
'Renat',
'Robert',
'Roch',
'Roderyk',
'Roger',
'Roland',
'Roman',
'Romeo',
'Romuald',
'Ronald',
'Rosłan',
'Rudolf',
'Rufus',
'Ryszard',
'Salomon',
'Samir',
'Sambor',
'Samson',
'Samuel',
'Sebastian',
'Serafin',
'Sergiusz',
'Serwacy',
'Seweryn',
'Sędomir',
'Sędzisław',
'Siemowit',
'Sław',
'Sławek',
'Sławomierz',
'Sławomir',
'Sobiesław',
'Sofroniusz',
'Stanisław',
'Starwit',
'Stefan',
'Stoigniew',
'Stoisław',
'Stojan',
'Strzeżymir',
'Subisław',
'Sulibor',
'Sulisław',
'Sykstus',
'Sylwan',
'Sylwester',
'Sylwiusz',
'Symeon',
'Syriusz',
'Szczepan',
'Szymon',
'Ścibor',
'Świętibor',
'Świętomir',
'Świętopełk',
'Świętosław',
'Tadeusz',
'Tarik',
'Telesfor',
'Telimena',
'Teobald',
'Teodor',
'Teodozjusz',
'Teofil',
'Tęgomir',
'Tobiasz',
'Tomasz',
'Tomisław',
'Tristan',
'Tulimir',
'Tulimierz',
'Tymon',
'Tymoteusz',
'Tytus',
'Urban',
'Ursyn',
'Wacław',
'Wahid',
'Waldemar',
'Walenty',
'Walentyn',
'Walerian',
'Walery',
'Walid',
'Walter',
'Wandelin',
'Wawrzyniec',
'Wiesław',
'Wiktor',
'Wilhelm',
'Wincenty',
'Wirgiliusz',
'Wirginiusz',
'Wisław',
'Witold',
'Witosław',
'Władysław',
'Włodzimierz',
'Włodzisław',
'Wojciech',
'Zachariasz',
'Zbigniew',
'Zdzisław',
'Zenon',
'Ziemowit',
'Zygmunt',
]